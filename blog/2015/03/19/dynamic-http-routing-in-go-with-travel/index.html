
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Dynamic HTTP Routing in Go with Travel - asynch.ro</title>
	<meta name="author" content="Benjamen Keroack">

	
	<meta name="description" content="One thing I found interesting while using the Pyramid web framework was the idea of &ldquo;traversal&rdquo; request routing. I&rsquo;ve implemented &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="asynch.ro" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">asynch.ro</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/blog/archives">Archives</a></li>
    <li><a href="/about">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/blog/archives">Archives</a></li>
    <li><a href="/about">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:asynch.ro">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
        
		<a class="bitbucket" href="https://bitbucket.org/bkeroack" title="BitBucket">BitBucket</a>
		
		
		<a class="github" href="https://github.com/bkeroack" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:asynch.ro">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Dynamic HTTP Routing in Go With Travel</h2>
	<div class="entry-content"><p>One thing I found interesting while using the <a href="http://www.pylonsproject.org/">Pyramid web framework</a> was the idea of <a href="http://docs.pylonsproject.org/docs/pyramid/en/latest/narr/traversal.html">&ldquo;traversal&rdquo;</a> request routing. I&rsquo;ve implemented an HTTP router in Go that offers similar functionality called <a href="https://github.com/bkeroack/travel">travel</a>.</p>

<p>If you read that traversal link above it may seem complex&mdash;it is, sort of&mdash;but let me break it down a bit and explain why I think it&rsquo;s cool:</p>

<p>Using travel, your job as the author is to provide the router with a &ldquo;root tree&rdquo; object<sup>1</sup>. This is a nested <code>map[string]interface{}</code> object that represents a tree of routable resources. Travel tokenizes the request URL and does a recursive lookup on the root tree. If it fails anywhere<sup>2</sup>, travel automatically returns an appropriate error to the client (404, etc). If it succeeds, it calls one of your named handlers according to a &ldquo;handler map&rdquo; you provide<sup>3</sup>.</p>

<p>The nice things about this approach (vs. static route patterns) are:</p>

<ul>
<li>Routing is dynamic: arbitrarily nested structures only known at runtime can be expressed in the URL and routed appropriately.</li>
<li>Less boilerplate code for RESTful endpoints: if your handler is called, the resources in question must exist. No need to do full table scans to, eg, check that user_id or whatever exists.</li>
<li>Separation of data concerns: since routing is done with a tree structure, you could separate out the root tree from the data it references (putting the root tree in a fast RAM-backed store for example) and only load data from the database for successful requests.</li>
</ul>


<p>To demonstrate some of these benefits I&rsquo;ve put together a couple of <a href="https://github.com/bkeroack/travel-examples">example applications</a>. The first of which is a nested HTTP key/value store&mdash;implemented in ~150 lines of Go&mdash;whose datastore backend is a single JSON file. There&rsquo;s a Vagrantfile in the root of the repository which makes it easy to run and test these applications.</p>

<h2>JSON Key-Value</h2>

<p>This program supports GET, PUT and DELETE verbs which retrieve, create/modify and remove keys, respectively. It expects JSON in the request body of a PUT request.</p>

<p>When you first start it up the store is empty:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>http GET http://192.168.10.10:8000
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Content-Length: 2
</span><span class='line'>Content-Type: application/json
</span><span class='line'>Date: Fri, 20 Mar 2015 15:34:26 GMT
</span><span class='line'>
</span><span class='line'><span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can create a simple key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;&quot;bar&quot;&#39;</span> <span class="p">|</span>http --body PUT http://192.168.10.10:8000/foo
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;success&quot;</span>: <span class="s2">&quot;value written&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;foo&quot;</span>: <span class="s2">&quot;bar&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Note that we have to wrap a string in double quotes for it to be valid JSON.)</p>

<p>We can also create a complex object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;{&quot;phone&quot;: &quot;111-222-3333&quot;, &quot;age&quot;: 32}&#39;</span> <span class="p">|</span>http --body PUT http://192.168.10.10:8000/mary
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;success&quot;</span>: <span class="s2">&quot;value written&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;foo&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;mary&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;age&quot;</span>: 32,
</span><span class='line'>        <span class="s2">&quot;phone&quot;</span>: <span class="s2">&quot;111-222-3333&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can create new nested values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;&quot;123 Main St.&quot;&#39;</span> <span class="p">|</span>http --body PUT http://192.168.10.10:8000/mary/address
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;success&quot;</span>: <span class="s2">&quot;value written&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;foo&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;mary&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;123 Main St.&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;age&quot;</span>: 32,
</span><span class='line'>        <span class="s2">&quot;phone&quot;</span>: <span class="s2">&quot;111-222-3333&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can alter existing nested values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;{&quot;home&quot;: &quot;999-999-9999&quot;}&#39;</span> <span class="p">|</span>http --body PUT http://192.168.10.10:8000/mary/phone
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;success&quot;</span>: <span class="s2">&quot;value written&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;foo&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;mary&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;123 Main St.&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;age&quot;</span>: 32,
</span><span class='line'>        <span class="s2">&quot;phone&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;home&quot;</span>: <span class="s2">&quot;999-999-9999&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course we can access any nested value directly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000/mary/phone/home
</span><span class='line'><span class="s2">&quot;999-999-9999&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;and we can delete any value directly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>http --body DELETE http://192.168.10.10:8000/mary/phone/home
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;success&quot;</span>: <span class="s2">&quot;value deleted&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;foo&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;mary&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;123 Main St.&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;age&quot;</span>: 32,
</span><span class='line'>        <span class="s2">&quot;phone&quot;</span>: <span class="o">{}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We <em>can&rsquo;t</em> do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>http --body GET http://192.168.10.10:8000/mary/phone/home
</span><span class='line'>404 Not Found: <span class="o">[</span>mary phone home<span class="o">]</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;&quot;bob&quot;&#39;</span> <span class="p">|</span>http --body PUT http://192.168.10.10:8000/this/path/does/not/exist/yet
</span><span class='line'>404 Not Found: <span class="o">[</span>this path does not exist yet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at the <a href="https://github.com/bkeroack/travel-examples/blob/master/json-key-value/main.go">code</a>:</p>

<ul>
<li>Every request is processed by a <a href="https://github.com/bkeroack/travel-examples/blob/master/json-key-value/main.go#L44-L131">single handler</a>.</li>
<li>Nowhere does it check if a key exists, nor does it recurse through the data structure at all. That is all handled by travel.</li>
</ul>


<p>It <a href="https://github.com/bkeroack/travel-examples/blob/master/json-key-value/main.go#L139-L151">initializes the travel router</a> using the options of &ldquo;strict traversal&rdquo;&mdash;essentially this means that the resulting handler name can either be &ldquo;&rdquo; (the empty string) if traversal fully succeeds or the first failed token if it does not fully succeed. It also sets the DefaultHandler to &ldquo;&rdquo; (again, the empty string) and sets a maximum subpath&mdash;any tokens remaining if traversal does not fully succeed&mdash;to one only for PUT requests (that&rsquo;s the only case where we want a successful request&mdash;key creation&mdash;if that path does not exist yet). Basically we&rsquo;re forcing all requests to either fail or call the default handler (&ldquo;&rdquo;).</p>

<p>It passes travel a simple function that reads and deserializes the JSON file. Travel calls this at the start of every request. Using the result returned from that function as the root tree, it performs traversal and either calls the appropriate handler if the request succeeds or the error handler if not.</p>

<p>Pretty cool that we can do this in ~150 lines. One big issue though is that this program is not safe for concurrent requests. Multiple simultaneous requests could overwrite each other&rsquo;s data or potentially corrupt the JSON file. How could we address this?</p>

<p>One way is to use PostgreSQL&rsquo;s JSON storage type instead of a simple file. The <a href="https://github.com/bkeroack/travel-examples/tree/master/postgres-key-value">next example application</a> is essentially identical to the one described above except for the functions that deal with root tree retrieval and storage. Everything else works exactly the same, but we make these modifications:</p>

<ul>
<li>Instead of a JSON file, we have a table called &ldquo;root_tree&rdquo; with three columns: sequential primary key, created timestamp, jsonb tree.</li>
<li>Rather than mutate a single row in that table on every request, if the request modifies the tree we simply insert a new row. The table serves as a history of all modifications going back in time.</li>
<li>The function that fetches the root tree at the start of each request does a simple SELECT on the table in descending order by primary key (which is sequential) with LIMIT 1. That way we get the latest version of the root tree.</li>
</ul>


<p>The root tree is fetched at the start of every request, so within the body of the request it should always be considered &lsquo;stale&rsquo; with respect to modification. To address this, we use an <a href="https://github.com/bkeroack/travel-examples/blob/master/postgres-key-value/main.go#L62-L69">advisory lock</a> after the modification request has been validated. We then use the context <a href="https://github.com/bkeroack/travel-examples/blob/master/postgres-key-value/main.go#L68">Refresh() method</a> to re-run traversal and give us the updated root tree. Since this thread holds the lock for modification, we are free to modify and write back the root tree to a new row. After we&rsquo;re done we <a href="https://github.com/bkeroack/travel-examples/blob/master/postgres-key-value/main.go#L71-L77">release the lock</a> (in theory it would be implicitly released anyway when the transaction is committed or rolled back, but I like to be explicit).</p>

<p>This program is now safe for concurrent requests, and this can be proven by running <code>GOMAXPROCS=2 go test</code>. This will <a href="https://github.com/bkeroack/travel-examples/blob/master/postgres-key-value/postgres-key-value_test.go#L116-L145">run 50 concurrent requests</a> and make sure they all succeed without data loss.</p>

<p>There are probably more clever ways of constructing the root tree that would not involve explicit locking&mdash;perhaps by building a tree structure on the fly from a set of resources. To me the interesting part of traversal is dynamic request routing without annoying boilerplate. Travel is a more-or-less direct translation of the idea into Go, but it&rsquo;s certainly possible that it can be improved.</p>

<p>I&rsquo;m open to any feature ideas or&mdash;preferably&mdash;simplifications. Feel free to open a Github issue and thanks for reading!</p>

<h2><p /></h2>

<ol>
<li>Actually you provide a callback function that fetches the root tree object.</li>
<li>This isn&rsquo;t strictly true&mdash;using traditional traversal semantics the lookup can fail in certain instances but still invoke a handler. The details are not terribly intuitive but can be found in the original documentation.</li>
<li>In the Pyramid/Pylons implementation, the author would provide a nested dictionary and would use decorators on &ldquo;view&rdquo; (handler) functions/classes to indicate their &ldquo;name&rdquo;. We obviously cannot do this in Go, so the &ldquo;handler map&rdquo; is a map[string]func that provides similar functionality.</li>
</ol>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-03-19T08:37:47-07:00" pubdate data-updated="true">Mar 19<sup>th</sup>, 2015</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/development/'>development</a>, <a class='category' href='/blog/categories/golang/'>golang,</a>, <a class='category' href='/blog/categories/http/'>http,</a>, <a class='category' href='/blog/categories/programming/'>programming,</a>, <a class='category' href='/blog/categories/traversal/'>traversal,</a>


</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Benjamen Keroack

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'asynchro';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://asynch.ro/blog/2015/03/19/dynamic-http-routing-in-go-with-travel/';
        var disqus_url = 'http://asynch.ro/blog/2015/03/19/dynamic-http-routing-in-go-with-travel/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-49212712-3']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>